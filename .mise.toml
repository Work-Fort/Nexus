[tools]
rust = { version = "latest", targets = "x86_64-unknown-linux-musl" }

[tasks.build]
description = "Build all crates (debug)"
run = """
cargo build -p guest-agent --target x86_64-unknown-linux-musl --release
cargo build
"""

[tasks."build:release"]
description = "Build all crates (release)"
run = "cargo build --release"

[tasks.test]
description = "Run all workspace tests"
run = "cargo test --workspace"

[tasks."test:unit"]
description = "Run unit tests only (no integration tests)"
run = "cargo test --workspace --lib"

[tasks."test:lib"]
description = "Run tests for nexus-lib"
run = "cargo test -p nexus-lib"

[tasks."test:nexusd"]
description = "Run tests for nexusd"
run = "cargo test -p nexusd"

[tasks."test:nexusctl"]
description = "Run tests for nexusctl"
run = "cargo test -p nexusctl"

[tasks."test:guest-agent"]
description = "Run tests for guest-agent"
run = "cargo test -p guest-agent"

[tasks."build:guest-agent"]
description = "Build guest-agent binary (requires: rustup target add x86_64-unknown-linux-musl)"
run = "cargo build -p guest-agent --target x86_64-unknown-linux-musl --release"

[tasks.run]
description = "Run nexusd (debug build)"
run = "cargo run -p nexusd --"

[tasks."run:nexusctl"]
description = "Run nexusctl (debug build)"
run = "cargo run -p nexusctl --"

[tasks.check]
description = "Check all crates for errors without building"
run = "cargo check --workspace"

[tasks.clippy]
description = "Run clippy lints"
run = "cargo clippy --workspace"

# nexusd install tasks
[tasks."install:nexusd:debug"]
description = "Install nexusd debug build + systemd unit"
depends = ["build"]
run = """
mkdir -p ~/.local/bin
cp target/debug/nexusd ~/.local/bin/
mkdir -p ~/.config/systemd/user
cp dist/nexus.service ~/.config/systemd/user/
systemctl --user daemon-reload

# Grant CAP_NET_ADMIN for networking features
if command -v setcap &> /dev/null; then
    sudo setcap cap_net_admin=+ep ~/.local/bin/nexusd
    echo "Granted CAP_NET_ADMIN to nexusd"
else
    echo "WARNING: setcap not found. Networking features will require manual capability grant."
    echo "See docs/networking.md for details."
fi

echo "Installed nexusd (debug) to ~/.local/bin/ and nexus.service"
"""

[tasks."install:nexusd:release"]
description = "Install nexusd release build + systemd unit"
depends = ["build:release"]
run = """
mkdir -p ~/.local/bin
cp target/release/nexusd ~/.local/bin/
mkdir -p ~/.config/systemd/user
cp dist/nexus.service ~/.config/systemd/user/
systemctl --user daemon-reload

# Grant CAP_NET_ADMIN for networking features
if command -v setcap &> /dev/null; then
    sudo setcap cap_net_admin=+ep ~/.local/bin/nexusd
    echo "Granted CAP_NET_ADMIN to nexusd"
else
    echo "WARNING: setcap not found. Networking features will require manual capability grant."
    echo "See docs/networking.md for details."
fi

echo "Installed nexusd (release) to ~/.local/bin/ and nexus.service"
"""

# nexusctl install tasks
[tasks."install:nexusctl:debug"]
description = "Install nexusctl debug build"
depends = ["build"]
run = """
mkdir -p ~/.local/bin
cp target/debug/nexusctl ~/.local/bin/
echo "Installed nexusctl (debug) to ~/.local/bin/"
"""

[tasks."install:nexusctl:release"]
description = "Install nexusctl release build"
depends = ["build:release"]
run = """
mkdir -p ~/.local/bin
cp target/release/nexusctl ~/.local/bin/
echo "Installed nexusctl (release) to ~/.local/bin/"
"""

# Aggregate install tasks
[tasks."install:release"]
description = "Install all binaries (release) + systemd unit"
depends = ["install:nexusd:release", "install:nexusctl:release"]

[tasks."install:debug"]
description = "Install all binaries (debug) + systemd unit"
depends = ["install:nexusd:debug", "install:nexusctl:debug"]

[tasks.rootfs]
description = "Build Alpine rootfs ext4 image"
run = "bash scripts/build-rootfs.sh --output artifacts/rootfs.ext4 --force"

[tasks."rootfs:clean"]
description = "Remove built rootfs artifacts"
run = "rm -rf artifacts/rootfs.ext4"

[tasks.clean]
description = "Remove all Nexus state (database, config, cache, drives)"
run = """
#!/usr/bin/env bash
set -e

echo "ðŸ§¹ Cleaning Nexus state..."

# Stop and remove systemd service (if exists - optional, for users who installed via systemd)
if command -v systemctl >/dev/null 2>&1; then
    if systemctl --user is-active --quiet nexusd 2>/dev/null; then
        echo "  â†’ Stopping systemd service"
        systemctl --user stop nexusd
    fi

    if systemctl --user is-enabled --quiet nexusd 2>/dev/null; then
        echo "  â†’ Disabling systemd service"
        systemctl --user disable nexusd
    fi

    if [ -f "$HOME/.config/systemd/user/nexusd.service" ]; then
        echo "  â†’ Removing systemd unit file"
        rm -f "$HOME/.config/systemd/user/nexusd.service"
        systemctl --user daemon-reload
    fi
fi

# Remove database (XDG_STATE_HOME, not XDG_DATA_HOME)
if [ -f "$HOME/.local/state/nexus/nexus.db" ]; then
    echo "  â†’ Removing database"
    rm -f "$HOME/.local/state/nexus/nexus.db"
    rm -f "$HOME/.local/state/nexus/nexus.db-shm"
    rm -f "$HOME/.local/state/nexus/nexus.db-wal"
fi

# Remove config
if [ -f "$HOME/.config/nexus/nexus.yaml" ]; then
    echo "  â†’ Removing config"
    rm -f "$HOME/.config/nexus/nexus.yaml"
fi

# Remove cache and assets
if [ -d "$HOME/.local/share/nexus/assets" ]; then
    echo "  â†’ Removing assets cache"
    rm -rf "$HOME/.local/share/nexus/assets"
fi

# Remove drives (btrfs subvolumes) using VFS workaround (no sudo needed)
# Same approach as btrfs.rs: unset read-only, remove contents, rmdir empty subvolume
if [ -d "$HOME/.local/share/nexus/drives" ]; then
    echo "  â†’ Removing drives"
    for subvol in "$HOME/.local/share/nexus/drives"/@*; do
        if [ -d "$subvol" ]; then
            echo "    â†’ Deleting subvolume: $(basename "$subvol")"
            # Make writable if read-only (same as libbtrfsutil::set_subvolume_read_only(false))
            if btrfs property get "$subvol" ro 2>/dev/null | grep -q 'ro=true'; then
                btrfs property set "$subvol" ro false
            fi
            # Remove contents via VFS, then rmdir the empty subvolume (kernel 4.18+)
            rm -rf "$subvol"/*
            rmdir "$subvol"
        fi
    done
    rm -rf "$HOME/.local/share/nexus/drives"
fi

echo "âœ… Nexus state cleaned"
"""

[tasks.integration-test]
description = "Run real integration tests (requires KVM + btrfs + network)"
run = """
#!/usr/bin/env bash
set -e

echo "ðŸ§ª Running Nexus integration tests..."
echo ""
echo "Prerequisites:"
echo "  - KVM access (/dev/kvm)"
echo "  - btrfs filesystem"
echo "  - Network connectivity"
echo ""

cargo build -p integration-tests --release
exec ./target/release/integration-test-runner
"""
