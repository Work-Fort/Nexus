[tools]
rust = "latest"

[tasks.build]
description = "Build all crates (debug)"
run = "cargo build"

[tasks."build:release"]
description = "Build all crates (release)"
run = "cargo build --release"

[tasks.test]
description = "Run all workspace tests"
run = "cargo test --workspace"

[tasks."test:unit"]
description = "Run unit tests only (no integration tests)"
run = "cargo test --workspace --lib"

[tasks."test:lib"]
description = "Run tests for nexus-lib"
run = "cargo test -p nexus-lib"

[tasks."test:nexusd"]
description = "Run tests for nexusd"
run = "cargo test -p nexusd"

[tasks."test:nexusctl"]
description = "Run tests for nexusctl"
run = "cargo test -p nexusctl"

[tasks.run]
description = "Run nexusd (debug build)"
run = "cargo run -p nexusd --"

[tasks."run:nexusctl"]
description = "Run nexusctl (debug build)"
run = "cargo run -p nexusctl --"

[tasks.check]
description = "Check all crates for errors without building"
run = "cargo check --workspace"

[tasks.clippy]
description = "Run clippy lints"
run = "cargo clippy --workspace"

# nexusd install tasks
[tasks."install:nexusd:debug"]
description = "Install nexusd debug build + systemd unit"
depends = ["build"]
run = """
mkdir -p ~/.local/bin
cp target/debug/nexusd ~/.local/bin/
mkdir -p ~/.config/systemd/user
cp dist/nexus.service ~/.config/systemd/user/
systemctl --user daemon-reload
echo "Installed nexusd (debug) to ~/.local/bin/ and nexus.service"
"""

[tasks."install:nexusd:release"]
description = "Install nexusd release build + systemd unit"
depends = ["build:release"]
run = """
mkdir -p ~/.local/bin
cp target/release/nexusd ~/.local/bin/
mkdir -p ~/.config/systemd/user
cp dist/nexus.service ~/.config/systemd/user/
systemctl --user daemon-reload
echo "Installed nexusd (release) to ~/.local/bin/ and nexus.service"
"""

# nexusctl install tasks
[tasks."install:nexusctl:debug"]
description = "Install nexusctl debug build"
depends = ["build"]
run = """
mkdir -p ~/.local/bin
cp target/debug/nexusctl ~/.local/bin/
echo "Installed nexusctl (debug) to ~/.local/bin/"
"""

[tasks."install:nexusctl:release"]
description = "Install nexusctl release build"
depends = ["build:release"]
run = """
mkdir -p ~/.local/bin
cp target/release/nexusctl ~/.local/bin/
echo "Installed nexusctl (release) to ~/.local/bin/"
"""

# Aggregate install tasks
[tasks."install:release"]
description = "Install all binaries (release) + systemd unit"
depends = ["install:nexusd:release", "install:nexusctl:release"]

[tasks."install:debug"]
description = "Install all binaries (debug) + systemd unit"
depends = ["install:nexusd:debug", "install:nexusctl:debug"]

[tasks.rootfs]
description = "Build Alpine rootfs ext4 image"
run = "bash scripts/build-rootfs.sh --output artifacts/rootfs.ext4 --force"

[tasks."rootfs:clean"]
description = "Remove built rootfs artifacts"
run = "rm -rf artifacts/rootfs.ext4"
